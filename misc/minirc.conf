#!/bin/sh

DAEMONS="dhcpcd sshd ntpd mdb mgo rds vnc btc dns smb pa"
ENABLED="@dhcpcd @sshd @ntpd @vnc @btc @dns"
UDEV="systemd"
NETWORK_INTERFACE="enp2s0"
HOSTNAME="$(cat /etc/hostname)"
LOG_DIR="/var/log/minirc"
PID_DIR="/tmp/minirc"

declare -r red="\033[1;31m"
declare -r green="\033[1;32m"
declare -r yellow="\033[1;33m"
declare -r cclear="\033[00m"

x_execute() {

    # $1 -> service
    # $2 -> user
    # $3 -> command

    local pid_file="$PID_DIR/$1.pid"
    local log_file="$LOG_DIR/$1.log"

    echo -e "${green}Starting $1...${cclear}"

    if [ ! -f "$pid_file" ]; then
        echo -e "user:    ${yellow}$2${cclear}"
        echo -e "command: ${yellow}$3${cclear}"
        echo -e "pid:     ${yellow}$pid_file${cclear}"
        echo -e "log:     ${yellow}$log_file${cclear}"
        sudo -u $2 sh -c "echo \$\$ > $pid_file; exec $3" |& awk '{ print strftime("[%Y-%m-%dT%H:%M:%S]"), $0; fflush(); }'  >> $log_file &
    else
        echo -e "${red}$pid_file exists${cclear}"
    fi

}

x_kill() {

    # $1 -> service

    local pid_file="$PID_DIR/$1.pid"

    echo -e "${red}Stopping $1...${cclear}"

    if [ -f "$pid_file" ]; then
        local pid=$(cat $pid_file)
        echo -e "killing $pid"
        sudo -u root sh -c "kill $pid && echo 'killed' && rm $pid_file"
    else
        echo -e "${red}$pid_file does not exist${cclear}"
    fi
}

x_test() {
    # $1 -> service
    local pid_file="$PID_DIR/$1.pid"

    test -f "$pid_file"
}

custom_start () {
    case "$1" in
    mdb)
        x_execute $1 mysql "/usr/bin/mysqld --init-file=/etc/mysql/init_file";;
    mgo)
        x_execute $1 root "/usr/bin/mongod --fork --config /etc/mongodb.conf";;
    rds)
        x_execute $1 root "/usr/bin/redis-server /etc/redis.conf";;
    smb)
        x_execute $1 root "smbd --log-stdout --foreground --no-process-group";;
    dhcpcd)
        x_execute $1 root "dhcpcd -n -B";;
    sshd)
        x_execute $1 root "/usr/bin/sshd -D";;
    ntpd)
        x_execute $1 root "ntpd -n -g -u ntp";;
    vnc)
        x_execute $1 igor "vncserver -fg";;
    btc)
        x_execute $1 igor "node /home/igor/arch/gdax/bitmex.js";;
    dns)
        x_execute $1 igor "/home/igor/arch/dyndns/dns.sh";;
    pa)
        x_execute $1 igor "/usr/bin/pulseaudio --daemonize=no";;
    all)
        default_start "$@";;
    *)
        echo -e "${red}unknown service $1${cclear}"
    esac
}

custom_stop () {
    case "$1" in
    all)
        default_stop "$@";;
    *)
        x_kill $1;;
    esac
}

custom_poll () {
    x_test $1
}
